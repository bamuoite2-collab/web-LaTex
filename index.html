<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI LaTeX Studio (Doraemon Edition)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']], // Cho ph√©p d√πng $...$ cho c√¥ng th·ª©c ng·∫Øn
      displayMath: [['$$', '$$'], ['\\[', '\\]']], // Cho ph√©p d√πng $$...$$ cho c√¥ng th·ª©c d√†i
      processEscapes: true,
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
<script id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
    <style>
        /* --- GIAO DI·ªÜN M·ªöI --- */
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            /* Thay ƒë·ªïi background th√†nh ·∫£nh Doraemon */
            /* --bg-gradient: linear-gradient(135deg, #e0e7ff 0%, #f3f4f6 100%); X√ìA D√íNG C≈® */
            --card-bg: rgba(255, 255, 255, 0.95); /* N·ªÅn th·∫ª tr·∫Øng m·ªù ƒë·ªÉ nh√¨n r√µ ch·ªØ tr√™n n·ªÅn ·∫£nh */
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border: #e5e7eb;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            /* C·∫§U H√åNH ·∫¢NH N·ªÄN DORAEMON */
            background: url('images.png') no-repeat center center fixed; 
            background-size: cover; /* ·∫¢nh ph·ªß k√≠n m√†n h√¨nh */
            margin: 0; padding: 40px 20px; color: var(--text-main); min-height: 100vh; 
        }
        
        .container { 
            max-width: 1000px; margin: 0 auto; background: var(--card-bg); 
            border-radius: 24px; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.2); overflow: hidden; 
            border: 1px solid rgba(255,255,255,0.8);
            backdrop-filter: blur(10px); /* Hi·ªáu ·ª©ng m·ªù k√≠nh c·ª±c ƒë·∫πp */
        }
        
        /* HEADER */
        .header { 
            background: rgba(255,255,255,0.8); padding: 25px 40px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .brand { font-size: 1.5em; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 12px; letter-spacing: -0.5px; }
        
        /* N√öT H∆Ø·ªöNG D·∫™N M√ÄU XANH BI·ªÇN */
        .help-pill { 
            background: #2563eb; /* M√†u xanh bi·ªÉn ƒë·∫≠m */
            color: white; /* Ch·ªØ tr·∫Øng */
            padding: 8px 20px; 
            border-radius: 99px; font-weight: 600; cursor: pointer; transition: 0.2s; border: none;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3);
        }
        .help-pill:hover { background: #1d4ed8; transform: translateY(-2px); }

        /* UPLOAD SECTION */
        .upload-section { padding: 40px; }
        
        .upload-box { 
            border: 2px dashed #c7d2fe; background: #eef2ff; border-radius: 16px; padding: 50px; 
            text-align: center; cursor: pointer; transition: 0.3s;
        }
        .upload-box:hover { border-color: var(--primary); background: #e0e7ff; transform: translateY(-2px); }
        .upload-box p { font-weight: 600; color: var(--primary); margin-top: 15px; font-size: 1.1em; }

        .mini-upload-btn { 
            display: none; background: #f0fdf4; border: 1px dashed var(--success); color: var(--success); 
            padding: 15px; width: 100%; text-align: center; border-radius: 12px; 
            cursor: pointer; margin-bottom: 20px; font-weight: 700; transition: 0.2s; 
        }
        .mini-upload-btn:hover { background: #dcfce7; }

        /* GRID ·∫¢NH & CONTROLS */
        .controls { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; margin-bottom: 20px; }
        .file-count { font-weight: 600; color: var(--text-sub); font-size: 0.9em; }
        .clear-btn { background: #fee2e2; color: var(--danger); border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; display: none; transition: 0.2s; }
        .clear-btn:hover { background: #fecaca; }

        #previewList { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; max-height: 400px; overflow-y: auto; padding: 5px; }
        .img-card { 
            position: relative; z-index: 10; border-radius: 12px; overflow: hidden; aspect-ratio: 3/4; 
            cursor: grab; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border); transition: 0.2s; background: white;
        }
        .img-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); z-index: 50 }
        .img-card img { width: 100%; height: 100%; object-fit: cover; }
        .zoom-modal { z-index: 9999 !important; }
        .card-actions { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; }
        .icon-btn { width: 28px; height: 28px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; transition: 0.2s; opacity: 0.9; }
        .icon-btn:hover { transform: scale(1.15); opacity: 1; }
        .btn-zoom { background: var(--success); }
        .btn-del { background: var(--danger); }
        .page-badge { position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: bold; pointer-events: none; }

        /* N√öT X·ª¨ L√ù */
        .process-area { margin-top: 30px; display: flex; flex-direction: column; gap: 15px; }
        .btn-main { 
            padding: 18px; border: none; border-radius: 14px; font-size: 16px; font-weight: 700; 
            cursor: pointer; width: 100%; color: white; display: flex; align-items: center; 
            justify-content: center; gap: 10px; transition: 0.3s; box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
        }
        .btn-convert { background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%); }
        .btn-convert:hover { transform: translateY(-2px); box-shadow: 0 10px 15px rgba(79, 70, 229, 0.3); }
        
        .btn-solve { background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); display: none; box-shadow: 0 4px 6px rgba(245, 158, 11, 0.2); }
        .btn-solve:hover { transform: translateY(-2px); box-shadow: 0 10px 15px rgba(245, 158, 11, 0.3); }
        
        .btn-main:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; filter: grayscale(100%); }
        .progress-bar { height: 6px; background: #e5e7eb; border-radius: 99px; overflow: hidden; display: none; margin-top: 15px; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.3s ease; border-radius: 99px; }

        /* K·∫æT QU·∫¢ & COPY */
        .result-section { padding: 40px; background: #f9fafb; border-top: 1px solid var(--border); display: none; animation: slideUp 0.4s ease; }
        @keyframes slideUp { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }
        .code-block { background: white; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); overflow: hidden; }
        .code-header { padding: 12px 20px; background: #f3f4f6; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-weight: 700; font-size: 0.95em; display: flex; align-items: center; gap: 8px; }
        .copy-btn { background: white; border: 1px solid var(--border); color: var(--text-main); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em; font-weight: 600; display: flex; align-items: center; gap: 6px; transition: 0.2s; }
        .copy-btn:hover { background: #f9fafb; border-color: var(--primary); color: var(--primary); }
        textarea { width: 100%; height: 180px; padding: 20px; border: none; resize: vertical; font-family: 'Consolas', monospace; font-size: 13px; line-height: 1.6; color: #374151; outline: none; box-sizing: border-box; }

        /* BUTTONS OVERLEAF */
        .export-group { display: flex; gap: 20px; margin-top: 10px; }
        .btn-export { flex: 1; padding: 15px; border: none; border-radius: 12px; font-weight: 700; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .exp-question { background: #0f766e; } .exp-question:hover { background: #0d9488; transform: translateY(-2px); }
        .exp-answer { background: #c2410c; } .exp-answer:hover { background: #ea580c; transform: translateY(-2px); }

        /* FLOATING BULB & MODALS */
        .bulb-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border-radius: 50%; box-shadow: 0 10px 25px rgba(245, 158, 11, 0.4); display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; cursor: pointer; z-index: 900; transition: 0.3s; border: none; animation: float 3s ease-in-out infinite; }
        .bulb-btn:hover { transform: scale(1.1); }
        @keyframes float { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-10px);} }

        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; width: 90%; max-width: 600px; padding: 30px; border-radius: 20px; position: relative; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from {opacity:0; transform:scale(0.9);} to {opacity:1; transform:scale(1);} }
        .close-modal { position: absolute; top: 20px; right: 20px; background: #f3f4f6; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-sub); font-size: 18px; transition: 0.2s; }
        .close-modal:hover { background: #e5e7eb; color: var(--danger); }

        .zoom-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; justify-content: center; align-items: center; flex-direction: column; }
        .zoom-modal img { max-width: 90%; max-height: 85vh; border-radius: 5px; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        .zoom-close { margin-top: 20px; padding: 10px 30px; background: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }

        .quota-box { max-width: 400px; text-align: center; border-top: 6px solid var(--warning); }
        .timer-circle { width: 90px; height: 90px; border-radius: 50%; border: 5px solid var(--warning); display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 800; color: var(--warning); margin: 25px auto; }
        
        .bulb-tips li { margin-bottom: 12px; padding: 10px; background: #fffbeb; border: 1px solid #fcd34d; border-radius: 8px; cursor: copy; font-family: monospace; font-size: 0.9em; color: #92400e; transition: 0.2s; }
        .bulb-tips li:hover { background: #fef3c7; transform: translateX(5px); }
    </style>
</head>
<body>

    <div id="quotaModal" class="modal-overlay">
        <div class="modal-box quota-box">
            <h2 style="color: var(--warning); margin: 0;">‚ö†Ô∏è H·ªá th·ªëng ƒëang b·∫≠n</h2>
            <p style="margin-top: 10px; color: var(--text-sub);">ƒêang t·ª± ƒë·ªông ƒë·ªïi ch√¨a kh√≥a AI d·ª± ph√≤ng...</p>
            <div class="timer-circle" id="quotaTimer">60</div>
        </div>
    </div>

    <div id="bulbModal" class="modal-overlay">
        <div class="modal-box">
            <div class="close-modal" onclick="toggleModal('bulbModal', false)">&times;</div>
            <h2 style="color: var(--warning); margin-top:0;"><i class="fas fa-lightbulb"></i> M·∫πo nh·ªè </h2>
            <p>N·∫øu ch∆∞a ∆∞ng √Ω, b·∫°n c√≥ th·ªÉ b·∫•m v√†o d√≤ng l·ªánh b√™n d∆∞·ªõi ƒë·ªÉ copy, sau ƒë√≥ g·ª≠i cho AI ƒë·ªÉ s·ª≠a code ƒë√£ xu·∫•t:</p>
            <ul class="bulb-tips" style="list-style: none; padding: 0;">
                <li onclick="copyText(this.innerText)">B·∫£ng n√†y b·ªã l·ªách, h√£y cƒÉn gi·ªØa v√† th√™m k·∫ª khung ƒë·∫ßy ƒë·ªß.</li>
                <li onclick="copyText(this.innerText)">H√¨nh v·∫Ω n√†y b·ªã nh·ªè qu√°, h√£y v·∫Ω to g·∫•p ƒë√¥i (scale=2).</li>
                <li onclick="copyText(this.innerText)">Chuy·ªÉn font ch·ªØ c√¥ng th·ª©c to√°n v·ªÅ d·∫°ng chu·∫©n Times New Roman.</li>
                <li onclick="copyText(this.innerText)">Ki·ªÉm tra l·∫°i ƒë√°p √°n tr·∫Øc nghi·ªám xem c√≥ ƒë√∫ng logic kh√¥ng.</li>
            </ul>
        </div>
    </div>

    <div id="guideModal" class="modal-overlay">
        <div class="modal-box">
            <div class="close-modal" onclick="toggleModal('guideModal', false)">&times;</div>
            <h2 style="color: var(--primary); margin-top: 0;">üìñ H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h2>
            <div style="margin-top: 20px; line-height: 1.8;">
                <p>1. <strong>Ch·ªçn ·∫£nh:</strong> T·∫£i ·∫£nh b√†i t·∫≠p (JPG/PNG).</p>
                <p>2. <strong>Chuy·ªÉn ƒë·ªïi:</strong> B·∫•m n√∫t <b>Xanh d∆∞∆°ng</b> ƒë·ªÉ l·∫•y ƒê·ªÅ b√†i.</p>
                <p>3. <strong>Gi·∫£i b√†i:</strong> B·∫•m n√∫t <b>V√†ng</b> n·∫øu c·∫ßn l·ªùi gi·∫£i.</p>
                <p>4. <strong>Xu·∫•t PDF:</strong> B·∫•m n√∫t Xanh/Cam ƒë·ªÉ m·ªü Overleaf.</p>
            </div>
            <button class="btn-main btn-convert" style="margin-top: 20px;" onclick="toggleModal('guideModal', false)">ƒê√£ hi·ªÉu</button>
        </div>
    </div>

    <div class="container">
      <div class="header">
            <div>
                <div class="brand"><i class="fas fa-magic"></i> AI LaTeX Studio</div>
                <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #4b5563; font-weight: 500;">
                    ‚ú® C√¥ng c·ª• chuy·ªÉn ƒë·ªïi ·∫£nh b√†i t·∫≠p sang LaTeX & Gi·∫£i chi ti·∫øt b·∫±ng AI
                </p>
            </div>
            <button class="help-pill" onclick="toggleModal('guideModal', true)">
                <i class="far fa-question-circle"></i> H∆∞·ªõng d·∫´n
            </button>
        </div>

        <div class="upload-section">
            <input type="file" id="fileInput" multiple accept=".jpg, .jpeg, .png" hidden onchange="handleFiles(this.files)">
            
            <div id="bigUploadBox" class="upload-box" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-cloud-upload-alt fa-3x" style="color: #818cf8; margin-bottom: 15px;"></i>
                <p>B·∫•m ƒë·ªÉ ch·ªçn ·∫£nh ho·∫∑c K√©o th·∫£ v√†o ƒë√¢y</p>
                <small>H·ªó tr·ª£ JPG, PNG (T·ªëi ∆∞u cho To√°n, L√Ω, H√≥a)</small>
            </div>

            <div id="miniUploadBtn" class="mini-upload-btn" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-plus-circle"></i> Th√™m ·∫£nh kh√°c
            </div>

            <div class="controls">
                <span id="fileCount" class="file-count"></span>
                <button class="clear-btn" id="clearBtn" onclick="clearAllFiles()">
                    <i class="fas fa-trash-alt"></i> X√≥a t·∫•t c·∫£
                </button>
            </div>

            <div id="previewList"></div>

            <div class="process-area">
                <button id="btnConvert" class="btn-main btn-convert" onclick="processData(this, '/convert_questions', 'questionCode')" disabled>
                    <i class="fas fa-bolt"></i> CHUY·ªÇN ƒê·ªîI ·∫¢NH
                </button>

                <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>

                <button id="btnSolve" class="btn-main btn-solve" onclick="processData(this, '/solve_problems', 'answerCode')">
                    <i class="fas fa-brain"></i> T·∫†O L·ªúI GI·∫¢I CHI TI·∫æT
                </button>
            </div>
        </div>

        <div class="result-section" id="resultSection">
            <div class="code-block">
                <div class="code-header">
                    <div class="header-title"><i class="fas fa-file-code" style="color: var(--primary)"></i> 1. Code ƒê·ªÅ B√†i</div>
                    <button class="copy-btn" onclick="copyCode('questionCode', this)">Copy Code</button>
                </div>
                <textarea id="questionCode" spellcheck="false"></textarea>
            </div>

            <div class="code-block">
                <div class="code-header">
                    <div class="header-title"><i class="fas fa-pen-nib" style="color: var(--warning)"></i> 2. Code L·ªùi Gi·∫£i</div>
                    <button class="copy-btn" onclick="copyCode('answerCode', this)">Copy Code</button>
                </div>
                <textarea id="answerCode" spellcheck="false" placeholder="B·∫•m n√∫t m√†u v√†ng ƒë·ªÉ AI gi·∫£i b√†i..."></textarea>
            </div>
<div class="code-block">
    <div class="code-header">
        <div class="header-title"><i class="fas fa-eye" style="color: var(--success)"></i> Xem tr∆∞·ªõc k·∫øt qu·∫£</div>
    </div>
    <div id="mathPreview" style="padding: 20px; background: white; min-height: 100px;"></div>
</div>
            <form action="https://www.overleaf.com/docs" method="post" target="_blank" id="overleafForm">
                <input type="hidden" name="snip" id="overleafSnip">
                <div class="export-group">
                    <button type="button" class="btn-export exp-question" onclick="sendToOverleaf('QUESTION')">
                        <i class="fas fa-file-pdf"></i> Xu·∫•t ƒê·ªÅ Thi (Overleaf)
                    </button>
                    <button type="button" class="btn-export exp-answer" onclick="sendToOverleaf('ANSWER')">
                        <i class="fas fa-file-signature"></i> Xu·∫•t L·ªùi Gi·∫£i (Overleaf)
                    </button>
                </div>
            </form>

            <div class="overleaf-guide" style="margin-top: 30px; padding: 25px; background: #ecfdf5; border: 1px solid #bbf7d0; border-radius: 12px;">
                <h3 style="color: #047857; margin-top: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-lightbulb"></i> C√°ch l·∫•y file PDF t·ª´ Overleaf
                </h3>
                <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 15px;">
                    <div style="flex: 1; min-width: 200px; background: white; padding: 15px; border-radius: 10px; border: 1px solid #d1fae5;">
                        <span style="background: #059669; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold;">B∆Ø·ªöC 1</span>
                        <p style="margin: 8px 0 0; color: #374151;">B·∫•m n√∫t xanh l√° <b>Recompile</b> ƒë·ªÉ ch·∫°y code.</p>
                    </div>
                    <div style="flex: 1; min-width: 200px; background: white; padding: 15px; border-radius: 10px; border: 1px solid #d1fae5;">
                        <span style="background: #059669; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold;">B∆Ø·ªöC 2</span>
                        <p style="margin: 8px 0 0; color: #374151;">B·∫•m bi·ªÉu t∆∞·ª£ng <b>Download</b> ngay c·∫°nh ƒë√≥ ƒë·ªÉ t·∫£i PDF.</p>
            </div>
        </div>
    </div>

    <button class="bulb-btn" onclick="toggleModal('bulbModal', true)" title="M·∫πo ch·ªânh s·ª≠a AI">
        <i class="fas fa-lightbulb"></i>
    </button>

    <div class="zoom-modal" id="zoomModal" onclick="if(event.target === this) this.style.display='none'">
    <img id="zoomImg" onclick="event.stopPropagation()">
    <button class="zoom-close" onclick="document.getElementById('zoomModal').style.display='none'">ƒê√≥ng (Esc)</button>
</div>

    <script>
        const API_BASE = '';
        let selectedFiles = [];

        window.onload = () => {
            if(!localStorage.getItem('v9_intro')) {
                toggleModal('guideModal', true);
                localStorage.setItem('v9_intro', 'true');
            }
        }

        function toggleModal(id, show) {
            document.getElementById(id).style.display = show ? 'flex' : 'none';
        }

     function handleFiles(files) {
    Array.from(files).forEach(file => {
        selectedFiles.push(file);
        const url = URL.createObjectURL(file);
        const div = document.createElement('div');
        div.className = 'img-card';
        div.fileObj = file; 
        
        // S·ª≠ d·ª•ng func thay v√¨ inline string ƒë·ªÉ tr√°nh l·ªói c√∫ ph√°p
        div.innerHTML = `
            <img src="${url}">
            <div class="card-actions">
                <button class="icon-btn btn-zoom"><i class="fas fa-search-plus"></i></button>
                <button class="icon-btn btn-del" onclick="removeFile(this)"><i class="fas fa-trash-alt"></i></button>
            </div>
            <div class="page-badge">Trang ?</div>
        `;
        
        // G√°n s·ª± ki·ªán click th·ªß c√¥ng ƒë·ªÉ ƒë·∫£m b·∫£o ch·∫°y 100%
        div.querySelector('img').onclick = () => openZoom(url);
        div.querySelector('.btn-zoom').onclick = () => openZoom(url);

        document.getElementById('previewList').appendChild(div);
    });
    document.getElementById('fileInput').value = ''; 
    updateUI();
}

        function removeFile(btn) {
            btn.closest('.img-card').remove();
            updateUI();
        }

        function clearAllFiles() {
            if(confirm('B·∫°n mu·ªën x√≥a t·∫•t c·∫£ ·∫£nh?')) {
                document.getElementById('previewList').innerHTML = '';
                updateUI();
                document.getElementById('resultSection').style.display = 'none';
            }
        }

        function updateUI() {
            const cards = document.querySelectorAll('.img-card');
            cards.forEach((card, index) => card.querySelector('.page-badge').innerText = `Trang ${index + 1}`);
            
            const hasFiles = cards.length > 0;
            document.getElementById('bigUploadBox').style.display = hasFiles ? 'none' : 'block';
            document.getElementById('miniUploadBtn').style.display = hasFiles ? 'block' : 'none';
            document.getElementById('btnConvert').disabled = !hasFiles;
            document.getElementById('fileCount').innerText = hasFiles ? `${cards.length} ·∫£nh ƒë√£ ch·ªçn` : '';
            document.getElementById('clearBtn').style.display = hasFiles ? 'flex' : 'none';
        }

        new Sortable(document.getElementById('previewList'), { animation: 150, onEnd: updateUI });

        function openZoom(url) {
            document.getElementById('zoomImg').src = url;
            document.getElementById('zoomModal').style.display = 'flex';
        }

        async function copyCode(elementId, btn) {
            const text = document.getElementById(elementId).value;
            if (!text) return;
            try {
                await navigator.clipboard.writeText(text);
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> ƒê√£ Copy!';
                btn.style.borderColor = 'var(--success)';
                btn.style.color = 'var(--success)';
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.style.borderColor = '';
                    btn.style.color = '';
                }, 2000);
            } catch (err) { alert('L·ªói copy: ' + err); }
        }
        
        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('ƒê√£ copy: "' + text + '"');
            });
        }

        async function processData(btn, endpoint, outputId) {
            const cards = document.querySelectorAll('.img-card');
            const originalText = btn.innerHTML;
            const progressBar = document.getElementById('progressFill');

            if (cards.length === 0) return;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';
            document.getElementById('progressBar').style.display = 'block';
            progressBar.style.width = '30%';

            const formData = new FormData();
            cards.forEach(card => formData.append('file', card.fileObj));

            try {
                let w = 30;
                const timer = setInterval(() => { if(w<90) progressBar.style.width = (++w) + '%' }, 100);

                const response = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'POST', body: formData
                });

                const data = await response.json();
                clearInterval(timer);
                progressBar.style.width = '100%';

                if (data.error && (data.error.includes("429") || data.error.includes("Quota"))) {
                    startQuotaCountdown(60); 
                    throw new Error("H·ªá th·ªëng ƒëang ƒë·ªïi key. Vui l√≤ng ƒë·ª£i.");
                }

                if (data.error) throw new Error(data.error);

                if (data.question_latex) {
                    document.getElementById('questionCode').value = data.question_latex;
                    document.getElementById('btnSolve').style.display = 'flex';
                }
                if (data.answer_latex) {
                    document.getElementById('answerCode').value = data.answer_latex;
                }
// --- TH√äM ƒêO·∫†N N√ÄY ---
    // 1. ƒê·ªï n·ªôi dung v√†o khung xem tr∆∞·ªõc
    document.getElementById('mathPreview').innerHTML = data.answer_latex;
    // 2. G·ªçi MathJax v·∫Ω c√¥ng th·ª©c
    if (window.MathJax) {
        MathJax.typesetPromise([document.getElementById('mathPreview')]);
    }
                document.getElementById('resultSection').style.display = 'block';
                document.getElementById('resultSection').scrollIntoView({behavior: 'smooth'});

            } catch (error) {
                if (!error.message.includes("ƒë·ªïi key")) alert("L·ªói: " + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
                setTimeout(() => { 
                    document.getElementById('progressBar').style.display = 'none'; 
                    progressBar.style.width = '0%';
                }, 1000);
            }
        }

        function startQuotaCountdown(seconds) {
            const timerDisplay = document.getElementById('quotaTimer');
            let timeLeft = seconds;
            toggleModal('quotaModal', true);
            const interval = setInterval(() => {
                timeLeft--;
                timerDisplay.innerText = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(interval);
                    toggleModal('quotaModal', false);
                }
            }, 1000);
        }

        function sendToOverleaf(mode) {
            const q = document.getElementById('questionCode').value;
            const a = document.getElementById('answerCode').value;
            
            let contentBody = "";
            let title = "";
            
            if (mode === 'QUESTION') {
                title = "ƒê·ªÄ B√ÄI KI·ªÇM TRA";
                contentBody = `\\section*{PH·∫¶N 1: ƒê·ªÄ B√ÄI}\n${q}`;
            } else {
                title = "H∆Ø·ªöNG D·∫™N GI·∫¢I CHI TI·∫æT";
                if (!a || a.trim() === "") {
                    contentBody = "% CH∆ØA C√ì L·ªúI GI·∫¢I. VUI L√íNG B·∫§M N√öT 'T·∫†O L·ªúI GI·∫¢I CHI TI·∫æT' TR∆Ø·ªöC.";
                } else {
                    contentBody = `\\section*{PH·∫¶N 2: L·ªúI GI·∫¢I CHI TI·∫æT}\n${a}`;
                }
            }
            
            const content = `
\\documentclass[12pt,a4paper]{article}
\\usepackage[utf8]{inputenc}
\\usepackage[vietnamese]{babel}
\\usepackage{amsmath,amssymb,graphicx,geometry,color,enumitem}
\\usepackage{booktabs, multirow, array, makecell}
\\usepackage{tikz, pgfplots}
\\usepackage{mathptmx} % FONT TIMES NEW ROMAN
\\pgfplotsset{compat=1.18}
\\usetikzlibrary{calc, angles, quotes, intersections, patterns} 

\\geometry{left=2cm,right=2cm,top=2cm,bottom=2cm}
\\setlength{\\parskip}{0.5em} 
\\setlength{\\parindent}{0pt}
\\setlist[enumerate,1]{label=\\textbf{\\Alph*.}, leftmargin=1.5cm, itemsep=5pt}

\\title{${title}}
\\date{\\today}

\\begin{document}
\\begin{center} \\textbf{\\Large ${title}} \\end{center}
\\vspace{0.5cm}
${contentBody}
\\end{document}`;
            
            document.getElementById('overleafSnip').value = content; 
            document.getElementById('overleafForm').submit();
        }
    </script>
</body>
</html>